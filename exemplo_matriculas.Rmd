---
title: "Básico da Linguagem e Data Frames"
author: "Leonardo Sangali Barone"
date: "25 de Outubro de 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

No exemplo anterior passamos rapidamente por uma quantidade grande de funções e características da linguagem R e produzimos um exemplo simples a partir de dados de educação do Portal de Dados Abertos da Prefeitura de São Paulo.

Neste exemplo, vamos utilizar o que aprendemos para produzir uma análise gráfica a partir dos dados de matrículas dos alunos da rede municipal. No processo, aprenderemos mais algumas coisas e veremos que, de novo, pouco código produz muita informação.

A base de dados contém uma linha para cada matrícula e 96 variáveis com informações sobre as matrículas.

## Base de dados de Matrícula

Vamos utilizar a base de dados de matrículas de 2016, disponível [aqui](http://dados.prefeitura.sp.gov.br/dataset/microdados-da-rede-municipal-de-ensino-matriculas/resource/a12a5380-cadf-41bf-bf6b-e8e39e1bc655). Para baixá-la, vamos repetir o que fizemos com o cadastro de escolas. Vamos guardar o URL da base:

```{r}
url_matriculas <- "http://dados.prefeitura.sp.gov.br/dataset/66218af2-c669-49bc-842c-df8fcc6364ca/resource/a12a5380-cadf-41bf-bf6b-e8e39e1bc655/download/microdadoseolmatriculas2016.rar"
```

E fazer o download dos dados. OBS: pode demorar bastante. Procure o pessoal do Pátio Digital para passar o arquivo para você se quiser e lembre de colocá-lo na pasta de trabalho (working directory). Você pode checar em qual pasta está trabalhando executando o comando "getwd()"

```{r}
download.file(url_matriculas, "matriculas16.rar")
```

Note que agora não estamos lidando com um arquivo de texto, mas uma paste arquivos compactados no formato .rar. Precisamos clicar para abrir o arquivo? De forma alguma. Vamos utilizar a função _unzip_:

```{r}
unzip("matriculas.rar")
```

E abrir os dados:

```{r}
matriculas <- read_delim(file = "Microdados_EOL_Matriculas_2016.csv", delim = ";")
```

## Estudantes com deficiência por turma nas EMEFs da rede municipal

Nosso objetivo será contar o número de estudantes com deficiência por turma nas EMEFs da rede municipal. Construíremos um gráfico de barras a partir da contagem.

Precisaremos do pacote _dplyr_ e convém já carregá-lo:

```{r}
library(dplyr)
```


Em primeiro lugar, precisamos identificar as variáveis que nos interessam. Podemos fazer isso recorrendo ao [dicionário](http://dados.prefeitura.sp.gov.br/dataset/microdados-da-rede-municipal-de-ensino-matriculas/resource/a59b705b-febc-4968-b406-360d4a163747?inner_span=True) (eu sugiro que você leia o dicionário se tiver tempo).

Precisaremos de 3 informações: o tipo de escola (para escolher apenas as EMEFs); o código de cada turma (para contar por turma quantos alunos com deficiência há); e uma variável que indique se o aluno tem ou não alguma deficiência declarada. As variáveis TIPO_ESCOLA, CD_TURMA e DEF_N_POSSUI, contém, respectivamente, tais informações.

O primeiro passo será renomeá-las:

```{r}
matriculas <- rename(matriculas, tipo = TIPO_ESCOLA, turma = CD_TURMA, deficiencia = DEF_N_POSSUI)
```

A seguir, "filtraremos" os dados selecionando apenas as linhas referentes a matrículas em EMEFs:

```{r}
matriculas <- mutate(matriculas, tipo == "EMEF")
```

Como a partir de agora precisaremos apenas das variáveis "turma" e "deficiencia", podemos excluir as demais usando a função _select_:

```{r}
matriculas <- select(matriculas, turma, deficiencia)
```

Há um pequeno problema. Queremos contar estudantes que têm alguma deficência. Mas a variável "deficiencia" é 0 para alun@s com deficiência e 1 para alunos sem deficiência. Vamos trocar os códigos fazendo uma pequena operação matemática (subtraindo 1 e multiplicando por -1):

```{r}
matriculas <- mutate(matriculas, deficiencia = (deficiencia - 1) * (-1))
```

Pronto! Temos agora no data frame só 2 variáveis e recodificamos a variável "deficiencia". Mas como contar quant@s alun@s com deficiência há em cada turma? O pacote _dplyr_ têm mais dois verbos que nos permitem "agrupar" dados: _group\_by_ e _summarise_. Vamos ver o uso conjunto desses verbos.

Em primeiro lugar, escolheremos por qual variável faremos o agrupamento, no caso, "turma":

```{r}
matriculas <- group_by(matriculas, turma)
```

Imediatamente a seguir, faremos um "sumário" da variável "deficiencia". Como queremos contar o número de alun@s com deficiência em cada turma, o "sumário" deverá conter uma variável "contagem". Também será interessante contar quantos estudantes tem ao todo nas turmas, informação que guardaremos na variável "total":

```{r}
matriculas <- summarise(matriculas, contagem = sum(deficiencia), total = n())
```

O que aconteceu? Transformamos um data frame que tinha uma matrícula em cada linha em um data frame que contém uma turma em cada linha, agora com a contagem do número de alun@s com deficiência e o total de estudantes na turma:

```{r}
head(matriculas)
```

